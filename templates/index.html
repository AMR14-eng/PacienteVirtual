<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Médica</title>
    <link rel="stylesheet" href="static/styles.css">
    <script>
        async function sendText() {
            const inputText = document.getElementById("inputText").value;
            const responseArea = document.getElementById("responseArea");
            const loading = document.getElementById("loading");


            if (!inputText) return;

            // Mostrar animación de carga
            loading.style.display = "block";

            try {
                const response = await fetch("/predict", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ text: inputText })
                });

                const data = await response.json();

                // Ocultar animación de carga
                loading.style.display = "none";

                if (response.ok) {
                    // Siempre mostrar lo que escribió el doctor (usuario)
                    responseArea.innerHTML += `<div class="message doctor"><strong>Doctor:</strong> ${inputText}</div>`;

                    if (data.intencion === "diagnostico") {
                        // Para diagnostico, mostrar solo el mensaje de felicitación o error
                        if (data.end) {
                            responseArea.innerHTML += `<div class="message patient"><strong>Paciente:</strong> Bien hecho, acertaste.</div>`;
                            alert("Diagnóstico correcto: consulta finalizada.");
                        } else {
                            responseArea.innerHTML += `<div class="message patient"><strong>Paciente:</strong> Ese no es el diagnóstico correcto. Intenta de nuevo.</div>`;
                            alert("Diagnóstico incorrecto: consulta finalizada.");
                        }
                        // Deshabilitar inputs al terminar
                        document.getElementById("sendButton").disabled = true;
                        document.getElementById("inputText").disabled = true;

                    } else {
                        // Para otras intenciones, mostrar la respuesta del paciente normal
                        responseArea.innerHTML += `<div class="message patient"><strong>Paciente:</strong> ${data.respuesta} </div>`;
                    }

                    document.getElementById("inputText").value = "";
                    responseArea.scrollTop = responseArea.scrollHeight;

                } else {
                    alert("Error del servidor: " + (data.error || "Desconocido"));
                }
            } catch (error) {
                loading.style.display = "none";
                alert("Error de conexión: " + error.message);
            }
        }

    </script>
</head>
<body>
    <div class="chat-container">
        <h1>Interacción de Consulta Médica</h1>
        <div id="responseArea">
            <div class="message patient"><strong>Paciente:</strong> Buenos días, doctor.</div>
        </div>
        <div id="loading" style="display:none; text-align:center; margin:10px 0;">
            <span>Cargando...</span>
        </div>
        <div class="input-container">
            <input type="text" id="inputText" placeholder="Escriba su pregunta aquí">
            <button id="sendButton" onclick="sendText()">Enviar</button>
        </div>
    </div>
</body>
</html>
